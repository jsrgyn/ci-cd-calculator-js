kind: pipeline
type: ssh
name: CI + push + Deploy HomologaÃ§Ã£o

# A seÃ§Ã£o 'node' nÃ£o Ã© mais necessÃ¡ria, pois o runner SSH nÃ£o usa labels
# para selecionar o servidor, ele usa a diretiva 'server'..
node:
   environment: ssh-build
   arch: arm64

trigger:
  event:
    - push
    - pull_request
    - tag

# mesma config de server.
server:
  host: build-server-node
  user: root
  ssh_key:
    from_secret: BUILD_SERVER_SSH_KEY

steps:
  # ...mesmos steps de setup, lint, testes, sonar...
  - name: Setup do Projeto
    commands:
      - npm ci
      - mkdir -p reports coverage

  - name: VerificaÃ§Ã£o de Lint
    commands:
      - npm run lint:report

  - name: Testes UnitÃ¡rios com Cobertura
    commands:
      - npm test -- --coverage

  - name: AnÃ¡lise e ValidaÃ§Ã£o do SonarQube
    environment:
      SONAR_TOKEN:
        from_secret: SONAR_TOKEN
      SONAR_HOST_URL:
        from_secret: SONAR_HOST_URL
    commands:
      - set -e
      - npx sonar-scanner -Dsonar.token=$SONAR_TOKEN -Dsonar.host.url=$SONAR_HOST_URL
    when:
      event:
        - push
        - pull_request
        - tag

  - name: Validar Quality Gate
    environment:
      SONAR_TOKEN:
        from_secret: SONAR_TOKEN
      SONAR_HOST_URL:
        from_secret: SONAR_HOST_URL
    commands:
      - set -e
      - |
        echo "Aguardando processamento da anÃ¡lise no SonarQube...."
        sleep 10
        taskId=$(curl -s -u "$SONAR_TOKEN:" "$SONAR_HOST_URL/api/project_analyses/search?project=calculadora-api" | jq -r '.current.component.analysisId')
        echo "Ãšltimo taskId: $taskId"
        status=""
        tentativas=0
        while [ "$status" != "SUCCESS" ] && [ $tentativas -lt 10 ]; do
          sleep 5
          status=$(curl -s -u "$SONAR_TOKEN:" "$SONAR_HOST_URL/api/ce/task?id=$taskId" | jq -r '.task.status')
          echo "Status: $status"
          tentativas=$((tentativas+1))
        done
        qualityStatus=$(curl -s -u "$SONAR_TOKEN:" "$SONAR_HOST_URL/api/qualitygates/project_status?projectKey=calculadora-api" | jq -r '.projectStatus.status')
        echo "Resultado do Quality Gate: $qualityStatus"
        if [ "$qualityStatus" != "OK" ]; then
          echo "âŒ Quality Gate falhou. Bloqueando deploy."
          exit 1
        else
          echo "âœ… Quality Gate aprovado. Continuando pipeline."
        fi
    when:
      event:
        - push
        - pull_request
        - tag

  # Nova etapa: Security Scan
  - name: Security Scan
    commands:
      - |
        # Executa o scan do cÃ³digo fonte e dependÃªncias
        trivy fs --severity HIGH,CRITICAL --exit-code 1 --no-progress . > trivy-report.txt
        
        # Verifica se encontrou vulnerabilidades
        if [ $? -ne 0 ]; then
          echo "##############################################################"
          echo "#               VULNERABILIDADES CRÃTICAS ENCONTRADAS        #"
          echo "#   Pipeline abortado por questÃµes de seguranÃ§a!             #"
          echo "##############################################################"
          echo "RelatÃ³rio completo:"
          cat trivy-report.txt
          exit 1
        else
          echo "âœ… Scan de seguranÃ§a aprovado. Nenhuma vulnerabilidade crÃ­tica encontrada."
        fi
    when:
      event: [push, tag]

  - name: OWASP Dependency Check
    commands:
      - mkdir -p reports/dependency-check
      - dependency-check --project "calculadora-api" --scan . --format HTML --format JSON --out reports/dependency-check
      - |
        # Verificar se hÃ¡ vulnerabilidades de alta severidade
        HIGH_VULNS=$(jq '.dependencies[].vulnerabilities[].severity' reports/dependency-check/dependency-check-report.json | grep -c '"HIGH"\|"CRITICAL"')
        if [ "$HIGH_VULNS" -gt 0 ]; then
          echo "########################################################"
          echo "# VULNERABILIDADES CRÃTICAS ENCONTRADAS: $HIGH_VULNS      #"
          echo "#   Pipeline abortado por questÃµes de seguranÃ§a        #"
          echo "########################################################"
          exit 1
        else
          echo "âœ… Nenhuma vulnerabilidade crÃ­tica encontrada nas dependÃªncias"
        fi
    when:
      event: [push, pull_request, tag]
    
  - name: E2E Tests (Staging)
    commands:
      - cd tests/e2e
      - npm install cypress mochawesome mochawesome-merge mochawesome-report-generator --save-dev
      - mkdir -p results
      - npx cypress run --config baseUrl=${CYPRESS_BASE_URL} --reporter mochawesome --reporter-options "reportDir=results,overwrite=false,html=false,json=true"
      - npx mochawesome-merge "results/*.json" > results/combined.json
      - npx marge results/combined.json -o results --reportTitle "Cypress Test Report"
      - cp -r results /usr/share/nginx/html/reports/e2e/
    environment:
      CYPRESS_BASE_URL: ${CYPRESS_BASE_URL}
    when:
      event: [push]
      branch: [main]

  # Deploy em HomologaÃ§Ã£o
  - name: Deploy em HomologaÃ§Ã£o
    commands:
       - set -e
       - echo ">>> Verificando seguranÃ§a antes do deploy..."
      
       # Executa o scan novamente para garantir
       - trivy fs --severity HIGH,CRITICAL --exit-code 1 --no-progress .
      
       - echo ">>> Iniciando deploy para HOMOLOGAÃ‡ÃƒO..."
       - pm2 stop calculadora-api-homolog || true
       - pm2 delete calculadora-api-homolog || true
       - pm2 start src/index.js --name calculadora-api-homolog
      
       # Gera relatÃ³rio final
       - trivy fs --format json -o reports/trivy-homolog-report.json .
       # Copiar relatÃ³rio para pasta acessÃ­vel
       - cp reports/dependency-check/dependency-check-report.html /usr/share/nginx/html/reports/
       - echo ">>> Deploy em HomologaÃ§Ã£o concluÃ­do."
    depends_on:
      - Security Scan
    when:
      event:
        - push
      branch:
        - main

  - name: Build Metrics
    commands:
      - apk add curl
      - |
        curl -X POST http://prometheus:9090/api/v1/import/prometheus \
          -d "drone_build_duration_seconds{repo=\"${DRONE_REPO}\", status=\"success\"} $(($(date +%s) - ${DRONE_BUILD_STARTED}))"
    when:
      status: [success, failure]
  
  # Adicionar etapa para expor relatÃ³rios
  - name: Publish Security Reports
    commands:
      - echo "RelatÃ³rios de seguranÃ§a disponÃ­veis em http://dashboard.local/reports/"
    when:
      status: [success]


  # --- ETAPA 4: DEPLOY EM PRODUÃ‡ÃƒO (Condicional). ---
  # CONDIÃ‡ÃƒO DE SEGURANÃ‡A: Somente quando um evento de TAG Ã© criado
  - name: Deploy em ProduÃ§Ã£o
    commands:
      - set -e
      - echo "ðŸš€ Verificando seguranÃ§a antes do deploy em PRODUÃ‡ÃƒO..."
      
      # Scan adicional com regras mais rigorosas
      - trivy fs --severity HIGH,CRITICAL --exit-code 1 --ignore-unfixed .
      
      - echo "ðŸš€ðŸš€ðŸš€ INICIANDO DEPLOY PARA PRODUÃ‡ÃƒO ðŸš€ðŸš€ðŸš€"
      - pm2 stop calculadora-api-prod || true
      - pm2 delete calculadora-api-prod || true
      - pm2 start src/index.js --name calculadora-api-prod
      
      # Gera relatÃ³rio detalhado
      - trivy fs --format template --template "@contrib/html.tpl" -o reports/trivy-prod-report.html .
      - echo "âœ… Deploy em ProduÃ§Ã£o concluÃ­do com sucesso."
    depends_on:
      - Security Scan
    when:
      event:
        - tag